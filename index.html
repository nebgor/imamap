<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perth PT Commute Sketch</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <link
    rel="icon"
    href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%230c172a"/><path d="M16 40c8-12 24-12 32 0" stroke="%237bdcb5" stroke-width="5" fill="none" stroke-linecap="round"/><circle cx="32" cy="24" r="6" fill="%2364b5ff"/></svg>'
  />
  <style>
    :root {
      --panel-bg: rgba(12, 16, 27, 0.9);
      --panel-text: #eaf3ff;
      --accent: #6fe7c9;
      --muted: #9fb1c7;
      --border: rgba(255, 255, 255, 0.14);
      --font: "Inter", system-ui, -apple-system, sans-serif;
      --rail: #64b5ff;
      --bg-1: #0b1020;
      --bg-2: #0f1a32;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at 35% 25%, #10213f 0%, #0b1228 50%, #080c1a 100%);
      font-family: var(--font);
      color: var(--panel-text);
      overflow: hidden;
    }
    #map {
      position: absolute;
      inset: 0;
      z-index: 0;
    }
    .panel {
      position: absolute;
      top: 14px;
      left: 14px;
      width: 340px;
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 14px 12px;
      backdrop-filter: blur(6px);
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.22);
      z-index: 1200;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 17px;
      letter-spacing: 0.4px;
      font-weight: 700;
      color: #e0fbff;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .row label {
      flex: 1;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.06);
      color: var(--panel-text);
      font-size: 14px;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    button {
      padding: 9px 14px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      letter-spacing: 0.2px;
      background: linear-gradient(120deg, #4dd4a4, #5fb3ff);
      color: #04131e;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.18);
    }
    button:active {
      transform: translateY(1px);
    }
    .legend {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .legend-bar {
      height: 12px;
      border-radius: 999px;
      background: linear-gradient(
        90deg,
        hsl(120, 75%, 45%),
        hsl(60, 80%, 52%),
        hsl(30, 85%, 55%),
        hsl(0, 80%, 50%)
      );
      border: 1px solid var(--border);
      margin: 6px 0 4px;
    }
    .legend-scale {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
    }
    .status {
      font-size: 12px;
      color: var(--muted);
    }
    .debug {
      position: absolute;
      bottom: 12px;
      left: 14px;
      background: rgba(8, 11, 20, 0.9);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      max-width: 460px;
      font-size: 12px;
      color: #cbd5e1;
      display: grid;
      gap: 4px;
      line-height: 1.4;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
      z-index: 1200;
    }
    .debug strong {
      color: #e2f3ff;
    }
    .rail-label {
      background: rgba(15, 102, 175, 0.5);
      color: #e7f6ff;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }
    .gallery {
      margin-top: 8px;
      border-top: 1px solid var(--border);
      padding-top: 8px;
      display: grid;
      gap: 6px;
    }
    .gallery h2 {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }
    .snapshots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }
    .snapshot-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px;
      display: grid;
      gap: 4px;
    }
    .snapshot-card img {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .snapshot-card button {
      width: 100%;
      padding: 6px 8px;
      background: rgba(255, 255, 255, 0.08);
      color: #d7e6ff;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: none;
    }
    .snapshot-meta {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }
    @media (max-width: 600px) {
      .panel {
        width: calc(100% - 24px);
        left: 12px;
        right: 12px;
      }
      .row {
        flex-direction: column;
      }
      .debug {
        max-width: calc(100% - 24px);
        left: 12px;
        right: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <h1>Perth PT commute sketch</h1>
    <div class="row">
      <label>Base wait (min)
        <input type="number" id="baseWait" value="8" min="0" step="1" />
      </label>
      <label>Network speed (km/h)
        <input type="number" id="netSpeed" value="40" min="1" step="1" />
      </label>
    </div>
    <div class="controls">
      <button id="recompute">Recompute</button>
      <button id="saveSnapshot">Save snapshot</button>
      <label style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="toggleRail" checked />
        Show rail lines
      </label>
    </div>
    <div class="legend">
      Commute minutes
      <div class="legend-bar"></div>
      <div class="legend-scale">
        <span>short</span><span>medium</span><span>long</span>
      </div>
    </div>
    <div class="status" id="status">Fetching stops…</div>
    <div class="gallery">
      <h2>Snapshots (cached locally)</h2>
      <div class="snapshots" id="snapshots"></div>
    </div>
  </div>
  <div class="debug" id="debug">
    <div><strong>Debug</strong> — ready</div>
    <div id="debug-meta"></div>
    <div id="debug-corridor"></div>
  </div>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  <script>
    const target = { lat: -31.9523, lon: 115.8590 };
    const STOP_CACHE_KEY = "stopsCacheV1";
    const SNAPSHOT_CACHE_KEY = "snapshotsV1";
    const STOP_CACHE_MAX_AGE_HRS = 6;
    const map = L.map("map", { zoomControl: false }).setView([target.lat, target.lon], 11);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors & Carto'
    }).addTo(map);
    L.control.zoom({ position: "bottomright" }).addTo(map);

    const stopsLayer = L.layerGroup().addTo(map);
    const railLayer = L.layerGroup().addTo(map);
    const stationLayer = L.layerGroup().addTo(map);

    const corridors = [
      // Mandurah line corridor
      [[-31.95, 115.86], [-32.0, 115.86], [-32.1, 115.86], [-32.18, 115.83], [-32.25, 115.8], [-32.35, 115.78], [-32.45, 115.75]],
      // Joondalup / Yanchep
      [[-31.95, 115.86], [-31.9, 115.84], [-31.83, 115.8], [-31.74, 115.75], [-31.63, 115.71], [-31.55, 115.7], [-31.48, 115.7]],
      // Fremantle
      [[-31.95, 115.86], [-31.99, 115.84], [-32.03, 115.8], [-32.05, 115.78]],
      // Midland
      [[-31.95, 115.86], [-31.92, 115.9], [-31.89, 115.95], [-31.87, 116.0], [-31.88, 116.05]],
      // Armadale / Thornlie
      [[-31.95, 115.86], [-32.0, 115.88], [-32.04, 115.92], [-32.08, 115.98], [-32.12, 116.02]],
      // Airport
      [[-31.95, 115.86], [-31.93, 115.89], [-31.92, 115.96], [-31.93, 116.0]],
      // Ellenbrook
      [[-31.95, 115.86], [-31.89, 115.91], [-31.85, 115.94], [-31.82, 115.97], [-31.78, 115.98]]
    ];

    const railLines = [
      {
        name: "Mandurah",
        points: [
          [-31.95, 115.86],
          [-31.977, 115.86],
          [-31.987, 115.859],
          [-32.008, 115.855], // Elizabeth Quay
          [-32.049, 115.85], // Canning Bridge
          [-32.064, 115.85], // Bull Creek
          [-32.073, 115.847], // Murdoch
          [-32.127, 115.852], // Cockburn
          [-32.175, 115.843], // Aubin Grove
          [-32.249, 115.821], // Rockingham
          [-32.279, 115.771], // Warnbro
          [-32.348, 115.757], // Lakelands-ish
          [-32.375, 115.757],
          [-32.45, 115.75] // Mandurah
        ]
      },
      {
        name: "Joondalup/Yanchep",
        points: [
          [-31.95, 115.86],
          [-31.936, 115.846], // Leederville
          [-31.917, 115.84], // Glendalough
          [-31.897, 115.81], // Stirling
          [-31.866, 115.8], // Warwick
          [-31.844, 115.782], // Greenwood
          [-31.819, 115.768], // Whitfords
          [-31.78, 115.756], // Edgewater
          [-31.746, 115.742], // Joondalup
          [-31.728, 115.735], // Currambine
          [-31.712, 115.732], // Clarkson
          [-31.689, 115.73], // Butler
          [-31.64, 115.71], // Alkimos
          [-31.58, 115.69], // Eglinton est.
          [-31.48, 115.7] // Yanchep approx
        ]
      },
      { name: "Fremantle", points: [[-31.95, 115.86], [-31.99, 115.84], [-32.03, 115.81], [-32.05, 115.78]] },
      { name: "Midland", points: [[-31.95, 115.86], [-31.92, 115.9], [-31.89, 115.96], [-31.87, 116.0], [-31.88, 116.05]] },
      { name: "Armadale/Thornlie", points: [[-31.95, 115.86], [-32.0, 115.88], [-32.04, 115.93], [-32.08, 115.98], [-32.12, 116.02]] },
      { name: "Airport", points: [[-31.95, 115.86], [-31.93, 115.89], [-31.92, 115.96], [-31.93, 116.0]] },
      { name: "Ellenbrook", points: [[-31.95, 115.86], [-31.89, 115.91], [-31.85, 115.94], [-31.82, 115.97], [-31.78, 115.98]] }
    ];

    const railStations = [
      // Core CBD
      { name: "Perth Station", lat: -31.9516, lon: 115.8605 },
      { name: "Perth Underground", lat: -31.9524, lon: 115.8579 },
      { name: "Elizabeth Quay", lat: -31.9563, lon: 115.8543 },
      // Mandurah line
      { name: "Canning Bridge", lat: -32.0494, lon: 115.8517 },
      { name: "Bull Creek", lat: -32.064, lon: 115.852 },
      { name: "Murdoch", lat: -32.071, lon: 115.85 },
      { name: "Cockburn Central", lat: -32.1267, lon: 115.85 },
      { name: "Aubin Grove", lat: -32.175, lon: 115.843 },
      { name: "Rockingham", lat: -32.2745, lon: 115.73 },
      { name: "Mandurah", lat: -32.536, lon: 115.742 },
      // Joondalup / Yanchep
      { name: "Leederville", lat: -31.9361, lon: 115.8414 },
      { name: "Glendalough", lat: -31.917, lon: 115.84 },
      { name: "Stirling", lat: -31.8962, lon: 115.8097 },
      { name: "Warwick", lat: -31.8592, lon: 115.807 },
      { name: "Whitfords", lat: -31.811, lon: 115.767 },
      { name: "Joondalup", lat: -31.744, lon: 115.768 },
      { name: "Butler", lat: -31.639, lon: 115.71 },
      { name: "Yanchep", lat: -31.55, lon: 115.69 },
      // Fremantle
      { name: "Subiaco", lat: -31.95, lon: 115.817 },
      { name: "Claremont", lat: -31.986, lon: 115.781 },
      { name: "Cottesloe", lat: -32.009, lon: 115.756 },
      { name: "Fremantle", lat: -32.053, lon: 115.748 },
      // Midland
      { name: "Claisebrook", lat: -31.9503, lon: 115.8735 },
      { name: "Bayswater", lat: -31.9147, lon: 115.9136 },
      { name: "Guildford", lat: -31.9, lon: 115.967 },
      { name: "Midland", lat: -31.889, lon: 116.005 },
      // Armadale / Thornlie
      { name: "Burswood", lat: -31.961, lon: 115.894 },
      { name: "Oats Street", lat: -31.9805, lon: 115.8974 },
      { name: "Thornlie", lat: -32.0618, lon: 115.9521 },
      { name: "Gosnells", lat: -32.079, lon: 115.999 },
      { name: "Armadale", lat: -32.153, lon: 116.016 },
      // Airport
      { name: "Redcliffe", lat: -31.927, lon: 115.949 },
      { name: "Airport Central", lat: -31.938, lon: 115.967 },
      { name: "High Wycombe", lat: -31.9405, lon: 116.007 },
      // Ellenbrook
      { name: "Bayswater (Ellenbrook)", lat: -31.9147, lon: 115.9136 },
      { name: "Noranda", lat: -31.865, lon: 115.897 },
      { name: "Malaga", lat: -31.846, lon: 115.89 },
      { name: "Whiteman Park", lat: -31.824, lon: 115.95 },
      { name: "Ellenbrook", lat: -31.776, lon: 115.97 }
    ];

    const hillsZone = { latMin: -32.05, latMax: -31.75, lonMin: 116.0, lonMax: 116.2 };

    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = (d) => (d * Math.PI) / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function pointSegmentDistance(p, a, b) {
      const toRad = (d) => (d * Math.PI) / 180;
      const latScale = 111;
      const x1 = (a[1] - p[1]) * Math.cos(toRad((a[0] + p[0]) / 2)) * latScale;
      const y1 = (a[0] - p[0]) * latScale;
      const x2 = (b[1] - p[1]) * Math.cos(toRad((b[0] + p[0]) / 2)) * latScale;
      const y2 = (b[0] - p[0]) * latScale;
      const dot = x1 * x2 + y1 * y2;
      const lenSq = x2 * x2 + y2 * y2;
      const t = Math.max(0, Math.min(1, lenSq === 0 ? 0 : dot / lenSq));
      const projX = t * x2;
      const projY = t * y2;
      const dx = projX - x1;
      const dy = projY - y1;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function corridorFactor(lat, lon) {
      let factor = 1;
      corridors.forEach((line) => {
        for (let i = 0; i < line.length - 1; i++) {
          const d = pointSegmentDistance([lat, lon], line[i], line[i + 1]);
          if (d < 1.5) {
            factor = Math.min(factor, 0.78 + d * 0.05);
          }
        }
      });
      if (
        lat >= hillsZone.latMin &&
        lat <= hillsZone.latMax &&
        lon >= hillsZone.lonMin &&
        lon <= hillsZone.lonMax
      ) {
        factor *= 1.12;
      }
      return factor;
    }

    function colourForMinutes(mins) {
      const clamped = Math.max(0, Math.min(90, mins));
      const ratio = clamped / 90;
      const hue = 120 - ratio * 120;
      const sat = 80;
      const light = 50 + ratio * 5;
      return `hsl(${hue}, ${sat}%, ${light}%)`;
    }

    function computeCommute(stop, baseWait, netSpeed) {
      const distanceKm = haversine(stop.lat, stop.lon, target.lat, target.lon);
      const corridor = corridorFactor(stop.lat, stop.lon);
      const effectiveSpeed = netSpeed * (1 / corridor);
      const rideMins = (distanceKm / Math.max(effectiveSpeed, 1)) * 60;
      return baseWait + rideMins;
    }

    function renderRailLines(show) {
      railLayer.clearLayers();
      stationLayer.clearLayers();
      if (!show) return;
      railLines.forEach((line) => {
        const poly = L.polyline(line.points, {
          color: "var(--rail)",
          weight: 4,
          opacity: 0.8,
          dashArray: "4 6"
        }).addTo(railLayer);
        const midpoint = line.points[Math.floor(line.points.length / 2)];
        L.marker(midpoint, {
          interactive: false,
          icon: L.divIcon({
            className: "rail-label",
            html: line.name,
            iconSize: null
          })
        }).addTo(railLayer);
      });
      railStations.forEach((st) => {
        L.circleMarker([st.lat, st.lon], {
          radius: 5,
          color: "#0b1220",
          weight: 1,
          fillColor: "#ffffff",
          fillOpacity: 0.9
        })
          .bindTooltip(st.name, { permanent: false, direction: "top", offset: [0, -4] })
          .addTo(stationLayer);
      });
    }

    function renderStops(stops, baseWait, netSpeed) {
      stopsLayer.clearLayers();
      const majorPattern = /(station|busport|interchange|terminus|bus station)/i;
      stops.forEach((stop) => {
        const commute = computeCommute(stop, baseWait, netSpeed);
        const color = colourForMinutes(commute);
        const isMajor = majorPattern.test(stop.stopname || "");
        L.circleMarker([stop.lat, stop.lon], {
          radius: isMajor ? 8 : 5.5,
          color: isMajor ? "#d9f99d" : "#0d1b2a",
          weight: 1,
          fillColor: color,
          fillOpacity: 0.9
        })
          .bindPopup(
            `<strong>${stop.stopname || "Stop"}</strong><br>ID: ${stop.stopid}<br>${commute.toFixed(1)} min`
          )
          .addTo(stopsLayer);
      });
      document.getElementById("status").textContent = `Rendered ${stops.length} stops`;
      const debugMeta = document.getElementById("debug-meta");
      debugMeta.textContent = `Stops: ${stops.length} · Base wait: ${baseWait} min · Speed: ${netSpeed} km/h`;
    }

    function readStopCache() {
      const cached = localStorage.getItem(STOP_CACHE_KEY);
      if (!cached) return null;
      try {
        const parsed = JSON.parse(cached);
        const ageHours = (Date.now() - parsed.ts) / 36e5;
        if (ageHours > STOP_CACHE_MAX_AGE_HRS) return null;
        return parsed.stops;
      } catch {
        return null;
      }
    }

    function writeStopCache(stops) {
      localStorage.setItem(STOP_CACHE_KEY, JSON.stringify({ ts: Date.now(), stops }));
    }

    async function fetchStops() {
      const status = document.getElementById("status");
      const cached = readStopCache();
      if (cached) {
        status.textContent = `Loaded ${cached.length} stops from cache`;
        return cached;
      }
      status.textContent = "Fetching stops…";
      const url =
        "https://services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Transport_Public_PT_Stops/FeatureServer/14/query" +
        "?where=1%3D1" +
        "&outFields=stopid,stopname" +
        "&geometry=-32.6,115.5,-31.4,116.2" +
        "&geometryType=esriGeometryEnvelope" +
        "&inSR=4326&spatialRel=esriSpatialRelIntersects" +
        "&outSR=4326&f=json";
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Failed to fetch stops: ${res.status}`);
      }
      const data = await res.json();
      const stops = (data.features || [])
        .map((f) => ({
          stopid: f.attributes.stopid,
          stopname: f.attributes.stopname,
          lat: f.geometry.y,
          lon: f.geometry.x
        }))
        .filter((s) => s.lat && s.lon);
      status.textContent = `Loaded ${stops.length} stops`;
      writeStopCache(stops);
      return stops;
    }

    function sampleCorridorDebug(lat, lon) {
      const factor = corridorFactor(lat, lon);
      const mins = computeCommute({ lat, lon }, Number(baseWait.value), Number(netSpeed.value));
      return { factor, mins };
    }

    async function init() {
      try {
        const stops = await fetchStops();
        window.__stops = stops;
        renderStops(stops, Number(baseWait.value), Number(netSpeed.value));
        renderRailLines(toggleRail.checked);
        const dbg = sampleCorridorDebug(-31.96, 115.86);
        document.getElementById("debug-corridor").textContent = `CBD sample corridor factor: ${dbg.factor.toFixed(2)} · est ${dbg.mins.toFixed(1)} min`;
        document.getElementById("debug").firstElementChild.textContent = "Debug — ok";
      } catch (e) {
        document.getElementById("status").textContent = e.message;
        document.getElementById("debug").firstElementChild.textContent = `Debug — ${e.message}`;
      }
    }

    document.getElementById("recompute").addEventListener("click", () => {
      if (!window.__stops) return;
      renderStops(window.__stops, Number(baseWait.value), Number(netSpeed.value));
    });
    document.getElementById("toggleRail").addEventListener("change", (e) => {
      renderRailLines(e.target.checked);
    });

    function loadSnapshots() {
      const raw = localStorage.getItem(SNAPSHOT_CACHE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveSnapshots(list) {
      localStorage.setItem(SNAPSHOT_CACHE_KEY, JSON.stringify(list));
    }

    function renderSnapshots() {
      const container = document.getElementById("snapshots");
      container.innerHTML = "";
      const snaps = loadSnapshots();
      snaps.forEach((snap) => {
        const card = document.createElement("div");
        card.className = "snapshot-card";
        const img = document.createElement("img");
        img.src = snap.dataUrl;
        img.alt = "Map snapshot";
        card.appendChild(img);
        const meta = document.createElement("div");
        meta.className = "snapshot-meta";
        meta.textContent = `${new Date(snap.ts).toLocaleString()} · z${snap.zoom}`;
        card.appendChild(meta);
        const btn = document.createElement("button");
        btn.textContent = "Load view";
        btn.onclick = () => {
          map.setView([snap.center.lat, snap.center.lon], snap.zoom);
          if (window.__stops) {
            renderStops(window.__stops, snap.baseWait, snap.netSpeed);
          }
        };
        card.appendChild(btn);
        const del = document.createElement("button");
        del.textContent = "Delete";
        del.onclick = () => {
          const next = loadSnapshots().filter((s) => s.id !== snap.id);
          saveSnapshots(next);
          renderSnapshots();
        };
        card.appendChild(del);
        container.appendChild(card);
      });
    }

    document.getElementById("saveSnapshot").addEventListener("click", () => {
      if (!window.leafletImage) {
        alert("Snapshot helper not loaded yet.");
        return;
      }
      leafletImage(map, (err, canvas) => {
        if (err) {
          alert("Snapshot failed");
          return;
        }
        const dataUrl = canvas.toDataURL("image/png");
        const snaps = loadSnapshots();
        const snap = {
          id: crypto.randomUUID(),
          ts: Date.now(),
          dataUrl,
          center: { lat: map.getCenter().lat, lon: map.getCenter().lng },
          zoom: map.getZoom(),
          baseWait: Number(baseWait.value),
          netSpeed: Number(netSpeed.value)
        };
        snaps.unshift(snap);
        const trimmed = snaps.slice(0, 6);
        saveSnapshots(trimmed);
        renderSnapshots();
      });
    });

    renderSnapshots();
    init();
  </script>
</body>
</html>
